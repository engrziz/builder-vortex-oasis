import { RequestHandler } from "express";

export interface ChatRequest {
  message: string;
  conversationHistory?: Array<{ role: 'user' | 'assistant'; content: string }>;
}

export interface ChatResponse {
  response: string;
  error?: string;
}

// Simple Arabic financial education responses for children
const getFinancialResponse = (message: string): string => {
  const lowerMessage = message.toLowerCase().trim();
  
  const responses: Record<string, string> = {
    'سيولة': 'السيولة هي سهولة تحويل الأشياء إلى نقود! 💧 مثل بيع لعبتك بسرعة للحصول على نقود. البيت صعب تحويله لنقو�� (سيولة قليلة) لكن النقود في البنك سهل سحبها (سيولة عالية)! 🏦💰',
    'سيوله': 'السيولة هي سهولة تحويل الأشياء إلى نقود! 💧 مثل بيع لعبتك بسرعة للحصول على نقود. البيت صعب تحويله لنقود (سيولة قليلة) لكن النقود في البنك سهل سحبها (سيولة عالية)! 🏦💰',
    'ما هي السيولة': 'السيولة هي سهولة تحويل الأشياء إلى نقود! 💧 مثل بيع لعبتك بسرعة للحصول على نقود. البيت صعب تحويله لنقود (سيولة قليلة) لكن النقود في البنك سهل سحبها (سيولة عالية)! 🏦💰',
    'ما معنى السيولة': 'السيولة هي سهولة تحويل الأشياء إلى نقود! 💧 مثل بيع لعبتك بسرعة للحصول على نقود. البيت صعب تحويله لنقود (سيولة قليلة) لكن النقود في البنك سهل سحبها (سيولة عالية)! 🏦💰',
    'معنى السيولة': 'السيولة هي سهولة تحويل الأشياء إلى نقود! 💧 مثل بيع لعبتك بسرعة للحصول على نقود. البيت صعب تحويله لنقود (سيولة ق��يلة) لكن النقود في البنك سهل سحبها (سيولة عالية)! 🏦💰',
    
    'مرحبا': 'مرحباً بك! أنا مساعدك لتعلم الأسهم والمال بطريقة سهلة وممتعة! 🌟 اسألني أي سؤال عن المال!',
    'السلام عليكم': 'وعليكم السلام ورحمة الله وبركاته! كيف يمكنني مساعدتك في تعلم الأموال اليوم؟ 😊',
    'هلا': 'أهلاً وسهلاً! هل تريد تعلم شيء جديد عن الأموال والأسهم؟ 🎈',
    
    'ما هي الأسهم': 'الأسهم هي مثل قطع صغيرة من الشركات! 🧩 عندما تشتري سهماً، تصبح مالكاً لجزء صغير من تلك الشركة. مثل لو كان لديك قطعة من كعكة كبيرة! 🍰',
    'ما هو السهم': 'السهم هو مثل تذكرة دخول لتصبح شريكاً في شركة! 🎫 كلما نجحت الشركة أكثر، كلما أصبحت تذكرتك أغلى! 💰',
    'كيف أشتري أسهم': 'لشراء الأسهم، تحتاج أولاً أن تكبر وتفتح حساباً في البنك أو شركة الوساطة. لكن يمكنك الآن أن تتعلم وتخطط! 📚✨',
    
    'ما هو المال': 'المال هو وسيلة نستخدمها لشراء الأشياء التي نحتاجها ونريدها! 💰 مثل الطعام والألعاب والكتب. يأتي من العمل والادخار! 🏦',
    'كيف أوفر المال': 'يمكنك توفير المال بوضع جزء من مصروفك في حصالة! مثلاً، إذا أعطاك والداك 10 ريال، ضع ريالين في الحصالة واستخدم الباقي! 💡',
    'لماذا نوفر المال': 'نوفر المال للأشياء المهمة في المستقبل! 🌟 مثل شراء لعبة غالية، أو الدراسة في الجامعة، أو حتى مساعدة الآخرين! ❤️',
    
    'ما هو الاستثمار': 'الاستثمار مثل زراعة البذور! 🌱 تضع مالك في مكان آمن لينمو ويصبح أكثر مع الوقت، مثل الشجرة التي تكبر وتعطي ثماراً! 🌳🍎',
    'لماذا أستثمر': 'نستثمر لأن المال الذي نتركه نائماً لا ينمو! 😴 لكن المال المستثمر يعمل لنا حتى ونحن نائمون! مثل النحلة التي تصنع العسل! 🐝🍯',
    
    'هل الأسهم آمنة': 'الأسهم مثل ركوب الأرجوحة! 🎢 أحياناً ت��عد وأحياناً تنزل. لهذا نتعلم أولاً ونستثمر أموالاً قليلة فقط! الأمان يأتي من التعلم! 📖',
    'ما هي المخاطر': 'المخاطر مثل المطر! ☔ أحياناً تحدث، لكن إذا كنا مستعدين بالمظلة (التعلم والتخطيط)، لن نبتل كثيراً! 🌂',
    
    'كيف أبدأ الادخار': 'ابدأ بحصالة صغيرة! ضع فيها ريالاً واحداً كل يوم، وستندهش كم ستجمع في الشهر! الادخار مثل لعبة ممتعة! 🎮',
    'ما أهمية الادخار': 'الادخار مثل المظلة في يوم ممطر! ☂️ يحمينا عندما نحتاج المال فجأة، ويساعدنا في تحقيق أحلامنا الكبيرة! ✨',
    
    'تضارب': 'التضارب هو شراء وبيع الأسهم بسرعة لربح سريع! 🎢 مثل شراء لعبة اليوم بـ10 ريال وبيعها غداً بـ15 ريال. لكن احذر! قد تنخفض لـ5 ريال! إنها مثل لعبة محفوفة بالمخاطر! 🎯⚠️',
    'ما معنى تضارب': 'التضارب هو شراء وبيع الأسهم بسرعة لربح سريع! 🎢 مثل شراء لعبة اليوم بـ10 ريال وبيعه�� غداً بـ15 ريال. لكن احذر! قد تنخفض لـ5 ريال! إنها مثل لعبة محفوفة بالمخاطر! 🎯⚠️',
    'معنى التضارب': 'التضارب هو شراء وبيع الأسهم بسرعة لربح سريع! 🎢 مثل شراء لعبة اليوم بـ10 ريال وبيعها غداً بـ15 ريال. لكن احذر! قد تنخفض لـ5 ريال! إنها مثل لعبة محفوفة بالمخاطر! 🎯⚠️',
    
    'ما هو التداول': 'التداول هو بيع وشراء الأسهم! 📈📉 مثل تبادل البطاقات مع أصدقائك، لكن بالأسهم! يحتاج صبر وتعلم كثير قبل أن تبدأ!',
    'كيف أتداول': 'التداول للكبار فقط! 👨‍💼 تحتاج أولاً أن تتعلم كثيراً وتكبر وتفهم المخاطر. الآن ركز على الادخار وتعلم أساسيات المال! 📚',
    
    'ما هي البورصة': 'البورصة مثل سوق كبير للأسهم! 🏪 الناس يأتون ليشتروا ويبيعوا أجزاء من الشركات. مثل سوق الخضار لكن للأسهم! 📊',
    'بورصة': 'البورصة مثل سوق كبير للأسهم! 🏪 الناس يأتون ليشتروا ويبيعوا أجزاء من الشركات. مثل سوق الخضار لكن للأسهم! 📊'
  };
  
  // Check for exact matches first
  for (const [key, response] of Object.entries(responses)) {
    if (lowerMessage.includes(key)) {
      return response;
    }
  }
  
  // Default response for financial topics
  return 'هذا سؤال رائع! 🌟 أنا أتخصص في تعليم الأموال والأسهم للأطفال. هل يمكنك أن تسأل عن شيء متعلق بالمال أو الأسهم؟ مثل "ما هي الأسهم؟" أو "كيف أوفر المال؟" أو "ما معنى السيولة؟" 💰📚';
};

export const handleAIChat: RequestHandler = async (req, res) => {
  try {
    const { message }: ChatRequest = req.body;

    if (!message || typeof message !== 'string') {
      return res.status(400).json({ 
        error: "الرسالة مطلوبة",
        response: "يرجى كتابة سؤالك! 😊"
      });
    }

    // Use our enhanced financial education responses
    const response = getFinancialResponse(message);
    
    console.log('✅ Smart financial AI response generated!');
    
    const chatResponse: ChatResponse = { response };
    res.json(chatResponse);

  } catch (error) {
    console.error('Chat API Error:', error);
    
    const fallbackResponse = "عذراً، حدث خطأ تقني! 😅 هل يمكنك المحاولة مرة أخرى؟ أنا هنا لأعلمك عن الأموال والأسهم! 💰📚";
    
    res.status(500).json({ 
      error: 'خطأ في الخادم',
      response: fallbackResponse
    });
  }
};
