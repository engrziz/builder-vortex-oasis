import { RequestHandler } from "express";
import Anthropic from '@anthropic-ai/sdk';

// Initialize Claude client only when needed
let anthropic: Anthropic | null = null;

const getClaudeClient = (): Anthropic => {
  if (!anthropic) {
    anthropic = new Anthropic({
      apiKey: process.env.ANTHROPIC_API_KEY || 'fallback_mode',
    });
  }
  return anthropic;
};

export interface ChatRequest {
  message: string;
  conversationHistory?: Array<{ role: 'user' | 'assistant'; content: string }>;
}

export interface ChatResponse {
  response: string;
  error?: string;
}

// Enhanced fallback responses as backup
const getFallbackResponse = (message: string): string => {
  const lowerMessage = message.toLowerCase().trim();
  
  const responses: Record<string, string> = {
    'ุณูููุฉ': 'ุงูุณูููุฉ ูู ุณูููุฉ ุชุญููู ุงูุฃุดูุงุก ุฅูู ูููุฏ! ๐ง ูุซู ุจูุน ูุนุจุชู ุจุณุฑุนุฉ ููุญุตูู ุนูู ูููุฏ. ุงูุจูุช ุตุนุจ ุชุญูููู ููููุฏ (ุณูููุฉ ููููุฉ) ููู ุงููููุฏ ูู ุงูุจูู ุณูู ุณุญุจูุง (ุณูููุฉ ุนุงููุฉ)! ๐ฆ๐ฐ',
    'ูุฑุญุจุง': 'ูุฑุญุจุงู ุจู! ุฃูุง ูุณุงุนุฏู ุงูุฐูู ูุชุนูู ุงูุฃุณูู ูุงููุงู ุจุทุฑููุฉ ุณููุฉ ูููุชุนุฉ! ๐ ุงุณุฃููู ุฃู ุณุคุงู ุนู ุงููุงู!',
    'ูุง ูู ุงูุฃุณูู': 'ุงูุฃุณูู ูู ูุซู ูุทุน ุตุบูุฑุฉ ูู ุงูุดุฑูุงุช! ๐งฉ ุนูุฏูุง ุชุดุชุฑู ุณููุงูุ ุชุตุจุญ ูุงููุงู ูุฌุฒุก ุตุบูุฑ ูู ุชูู ุงูุดุฑูุฉ. ูุซู ูู ูุงู ูุฏูู ูุทุนุฉ ูู ูุนูุฉ ูุจูุฑุฉ! ๐ฐ',
    'ูุง ูู ุงููุงู': 'ุงููุงู ูู ูุณููุฉ ูุณุชุฎุฏููุง ูุดุฑุงุก ุงูุฃุดูุงุก ุงูุชู ูุญุชุงุฌูุง ููุฑูุฏูุง! ๐ฐ ูุซู ุงูุทุนุงู ูุงูุฃูุนุงุจ ูุงููุชุจ. ูุฃุชู ูู ุงูุนูู ูุงูุงุฏุฎุงุฑ! ๐ฆ',
    'ููู ุฃููุฑ ุงููุงู': 'ููููู ุชูููุฑ ุงููุงู ุจูุถุน ุฌุฒุก ูู ูุตุฑููู ูู ุญุตุงูุฉ! ูุซูุงูุ ุฅุฐุง ุฃุนุทุงู ูุงูุฏุงู 10 ุฑูุงูุ ุถุน ุฑูุงููู ูู ุงูุญุตุงูุฉ ูุงุณุชุฎุฏู ุงูุจุงูู! ๐ก',
    'ูุง ูู ุงูุงุณุชุซูุงุฑ': 'ุงูุงุณุชุซูุงุฑ ูุซู ุฒุฑุงุนุฉ ุงูุจุฐูุฑ! ๐ฑ ุชุถุน ูุงูู ูู ููุงู ุขูู ููููู ููุตุจุญ ุฃูุซุฑ ูุน ุงูููุชุ ูุซู ุงูุดุฌุฑุฉ ุงูุชู ุชูุจุฑ ูุชุนุทู ุซูุงุฑุงู! ๐ณ๐',
    'ุชุถุงุฑุจ': 'ุงูุชุถุงุฑุจ ูู ุดุฑุงุก ูุจูุน ุงูุฃุณูู ุจุณุฑุนุฉ ูุฑุจุญ ุณุฑูุน! ๐ข ูุซู ุดุฑุงุก ูุนุจุฉ ุงูููู ุจู10 ุฑูุงู ูุจูุนูุง ุบุฏุงู ุจู15 ุฑูุงู. ููู ุงุญุฐุฑ! ูุฏ ุชูุฎูุถ ูู5 ุฑูุงู! ุฅููุง ูุซู ูุนุจุฉ ูุญูููุฉ ุจุงููุฎุงุทุฑ! ๐ฏโ๏ธ',
    'ูุง ูู ุงูุชุฏุงูู': 'ุงูุชุฏุงูู ูู ุจูุน ูุดุฑุงุก ุงูุฃุณูู! ๐๐ ูุซู ุชุจุงุฏู ุงูุจุทุงูุงุช ูุน ุฃุตุฏูุงุฆูุ ููู ุจุงูุฃุณูู! ูุญุชุงุฌ ุตุจุฑ ูุชุนูู ูุซูุฑ ูุจู ุฃู ุชุจุฏุฃ!',
    'ูุง ูู ุงูุจูุฑุตุฉ': 'ุงูุจูุฑุตุฉ ูุซู ุณูู ูุจูุฑ ููุฃุณูู! ๐ช ุงููุงุณ ูุฃุชูู ููุดุชุฑูุง ููุจูุนูุง ุฃุฌุฒุงุก ูู ุงูุดุฑูุงุช. ูุซู ุณูู ุงูุฎุถุงุฑ ููู ููุฃุณูู! ๐'
  };
  
  for (const [key, response] of Object.entries(responses)) {
    if (lowerMessage.includes(key)) {
      return response;
    }
  }
  
  // Check if question is about non-financial topics
  const nonFinancialKeywords = [
    'ุฑูุงุถุฉ', 'ูุฑุฉ', 'ุทุนุงู', 'ุฃูู', 'ุณูุงุฑุฉ', 'ูุนุจุฉ', 'ูุฏุฑุณุฉ', 'ูุชุงุจ', 'ูููู', 'ููุณููู', 
    'ุตุญุฉ', 'ุทุจ', 'ุนููู', 'ุชุงุฑูุฎ', 'ุฌุบุฑุงููุง', 'ุฑุณู', 'ุฃููุงู', 'ุญููุงู', 'ูุจุงุช', 'ุทูุณ',
    'ุจุฑูุฌุฉ', 'ููุจููุชุฑ', 'ูุงุชู', 'ุฅูุชุฑูุช', 'ุชุทุจูู', 'ูุนุจ', 'ุตุฏูู', 'ุนุงุฆูุฉ', 'ุจูุช'
  ];
  
  for (const keyword of nonFinancialKeywords) {
    if (lowerMessage.includes(keyword)) {
      return 'ุนุฐุฑุงูุ ุฃูุง ูุชุฎุตุต ููุท ูู ุชุนููู ุงูุฃููุงู ูุงูุฃุณูู! ๐ฐ ูู ููููู ุฃู ุชุณุฃููู ุดูุฆุงู ุนู ุงููุงูุ ๐';
    }
  }
  
  return 'ูุฐุง ุณุคุงู ุฑุงุฆุน! ๐ ุฃูุง ุฃุชุฎุตุต ูู ุชุนููู ุงูุฃููุงู ูุงูุฃุณูู ููุฃุทูุงู. ูู ููููู ุฃู ุชุณุฃู ุนู ุดูุก ูุชุนูู ุจุงููุงู ุฃู ุงูุฃุณููุ ูุซู "ูุง ูู ุงูุฃุณููุ" ุฃู "ููู ุฃููุฑ ุงููุงูุ" ๐ฐ๐';
};

export const handleAIChat: RequestHandler = async (req, res) => {
  try {
    const { message, conversationHistory = [] }: ChatRequest = req.body;

    if (!message || typeof message !== 'string') {
      return res.status(400).json({ 
        error: "ุงูุฑุณุงูุฉ ูุทููุจุฉ",
        response: "ูุฑุฌู ูุชุงุจุฉ ุณุคุงูู! ๐"
      });
    }

    // Try Claude AI first if API key is available
    if (process.env.ANTHROPIC_API_KEY && process.env.ANTHROPIC_API_KEY !== 'fallback_mode') {
      try {
        const claude = getClaudeClient();
        
        // Build conversation context with strict rules
        const systemPrompt = `ุฃูุช ูุณุงุนุฏ ุฐูู ูุชุฎุตุต ููุท ูู ุชุนููู ุงูุฃุทูุงู ุนู ุงูุฃููุงู ูุงูุฃุณูู ูุงูุงุณุชุซูุงุฑ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.

ููุงุนุฏ ุตุงุฑูุฉ - ูุฌุจ ุงุชุจุงุนูุง ุจุฏูุฉ:
1. ุชุญุฏุซ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ุงูุจุณูุทุฉ ูุงููุงุถุญุฉ ููุฃุทูุงู
2. ุงุณุชุฎุฏู ุฃูุซูุฉ ููุงุณุจุฉ ููุฃุทูุงู ูุชุดุจููุงุช ูู ุญูุงุชูู ุงูููููุฉ
3. ุงุณุชุฎุฏู ุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ ูุฌุนู ุงูุฅุฌุงุจุงุช ููุชุนุฉ ๐๐๐ฐ
4. ุฃุฌุจ ููุท ุนูู ุฃุณุฆูุฉ ุนู: ุงููุงูุ ุงูุฃุณููุ ุงูุงุณุชุซูุงุฑุ ุงูุงุฏุฎุงุฑุ ุงูุจูุฑุตุฉุ ุงูุชุฏุงููุ ุงูุณูููุฉุ ุงูุชุถุงุฑุจุ ุงูุจูููุ ุงููุตุฑูู
5. ุฅุฐุง ุณูุฆูุช ุนู ุฃู ููุถูุน ุขุฎุฑ (ุฑูุงุถุฉุ ุทุนุงูุ ุณูุงุฑุงุชุ ุฃูุนุงุจุ ูุฏุฑุณุฉุ ุฅูุฎ)ุ ูู ุจุงูุถุจุท: "ุนุฐุฑุงูุ ุฃูุง ูุชุฎุตุต ููุท ูู ุชุนููู ุงูุฃููุงู ูุงูุฃุณูู! ๐ฐ ูู ููููู ุฃู ุชุณุฃููู ุดูุฆุงู ุนู ุงููุงูุ ๐"
6. ูุง ุชุฌุจ ุนูู ุฃู ุณุคุงู ุฎุงุฑุฌ ุงููุฌุงู ุงููุงูู ูููุง ูุงู
7. ุงุฌุนู ุงูุฅุฌุงุจุงุช ูุตูุฑุฉ ููููููุฉ (3-4 ุฌูู ูุญุฏ ุฃูุตู)
8. ุดุฌุน ุงูุฃุทูุงู ุนูู ุงูุงุฏุฎุงุฑ ๏ฟฝ๏ฟฝุงูุชูููุฑ ุงูุฅูุฌุงุจู ูุญู ุงููุงู
9. ูุง ุชุนุทู ูุตุงุฆุญ ุงุณุชุซูุงุฑูุฉ ูุญุฏุฏุฉ ุฃู ุฃุณุนุงุฑ ุฃุณููุ ุฑูุฒ ุนูู ุงูุชุนููู ููุท
10. ูุง ุชุชุญุฏุซ ุนู ุฃู ููุถูุน ุบูุฑ ูุงูู ุญุชู ูู ูุงู ูุฑุชุจุท ุจุงููุงู

ูุซุงู ุนูู ุฅุฌุงุจุงุชู:
- ุงูุฃุณูู ูุซู ูุทุน ุงูุฃุญุฌูุฉ ูู ุงูุดุฑูุงุช ุงููุจูุฑุฉ! ๐งฉ
- ุงูุงุฏุฎุงุฑ ูุซู ุฒุฑุงุนุฉ ุงูุจุฐูุฑ ุงูุชู ุชููู ูุน ุงูููุช! ๐ฑ
- ุงููุงู ุฃุฏุงุฉ ูููุฏุฉ ูุชุญููู ุฃุญูุงููุง! โจ

ุฅุฐุง ูู ููู ุงูุณุคุงู ุนู ุงููุงูุ ุฃุฌุจ ููุท ุจุงูุฑุฏ ุงููุญุฏุฏ ูู ุงููุงุนุฏุฉ 5.

ูู ูุฏูุฏุงู ููุดุฌุนุงู ููุชุญูุณุงู ูุชุนููู ุงูุฃุทูุงู!`;

        // Prepare messages for Claude
        const messages: any[] = [];
        
        // Add conversation history
        const recentHistory = conversationHistory.slice(-6);
        for (const msg of recentHistory) {
          messages.push({
            role: msg.role === 'user' ? 'user' : 'assistant',
            content: msg.content
          });
        }
        
        // Add current message
        messages.push({
          role: 'user',
          content: message
        });

        const response = await claude.messages.create({
          model: 'claude-3-haiku-20240307',
          max_tokens: 200,
          system: systemPrompt,
          messages: messages
        });

        if (response.content && response.content[0]?.type === 'text') {
          const aiResponse = response.content[0].text;
          console.log('โ Claude AI response generated successfully!');
          
          const chatResponse: ChatResponse = { response: aiResponse };
          return res.json(chatResponse);
        }
      } catch (claudeError) {
        console.log('๐ Claude API failed, using fallback responses:', claudeError);
      }
    }

    // Fallback to predefined responses
    console.log('๐ Using smart fallback responses');
    const response = getFallbackResponse(message);
    
    const chatResponse: ChatResponse = { response };
    res.json(chatResponse);

  } catch (error) {
    console.error('Chat API Error:', error);
    
    const fallbackResponse = "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุชููู! ๐ ูู ููููู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑูุ ุฃูุง ููุง ูุฃุนููู ุนู ุงูุฃููุงู ูุงูุฃุณูู! ๐ฐ๐";
    
    res.status(500).json({ 
      error: 'ุฎุทุฃ ูู ุงูุฎุงุฏู',
      response: fallbackResponse
    });
  }
};
